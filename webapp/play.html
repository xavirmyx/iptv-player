<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover">
<title>IPTV Silver Pro — Ultimate Player</title>
<meta name="theme-color" content="#000000">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

<script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
<script src="https://unpkg.com/feather-icons"></script>

<style>
/* ---------------------------
   DISEÑO SILVER / DARK METAL
   --------------------------- */
:root {
  --bg-deep: #050505;
  --bg-panel: #0f1114;
  --bg-glass: rgba(20, 22, 26, 0.75);
  --metal-light: #e3e3e3;
  --metal-dark: #8c8c8c;
  --metal-grad: linear-gradient(145deg, #e3e3e3, #999999);
  --accent-glow: rgba(255, 255, 255, 0.15);
  --border: rgba(255, 255, 255, 0.08);
  --radius: 16px;
  --font-main: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
  --safe-area-bottom: env(safe-area-inset-bottom);
}

* { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
body {
  margin: 0; padding: 0;
  background-color: var(--bg-deep);
  color: #fff;
  font-family: var(--font-main);
  height: 100vh; overflow: hidden;
  display: flex; flex-direction: column;
}

/* FONDO ANIMADO SUTIL */
.ambient-bg {
  position: fixed; inset: 0; z-index: -1;
  background: radial-gradient(circle at 50% -20%, #2a2a2a 0%, #000 70%);
  opacity: 0.6; pointer-events: none;
}

/* HEADER */
.top-bar {
  display: flex; align-items: center; justify-content: space-between;
  padding: 12px 20px;
  background: rgba(0,0,0,0.4);
  backdrop-filter: blur(10px);
  border-bottom: 1px solid var(--border);
  z-index: 50;
}
.brand { display: flex; align-items: center; gap: 12px; }
.brand-logo { 
  width: 40px; height: 40px; border-radius: 8px; 
  background: var(--metal-grad); 
  display: flex; align-items: center; justify-content: center;
  color: #000; font-weight: 900; font-size: 18px; box-shadow: 0 0 15px rgba(255,255,255,0.1);
}
.brand-info h1 { margin: 0; font-size: 16px; letter-spacing: 0.5px; background: var(--metal-grad); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
.brand-info p { margin: 0; font-size: 11px; color: #888; }

.top-actions { display: flex; gap: 8px; }

/* BOTONES METÁLICOS */
.btn-icon {
  background: rgba(255,255,255,0.05); border: 1px solid var(--border);
  color: #ccc; padding: 8px; border-radius: 10px; cursor: pointer;
  transition: all 0.2s ease; display: flex; align-items: center; justify-content: center;
}
.btn-icon:hover { background: rgba(255,255,255,0.15); color: #fff; transform: translateY(-2px); }
.btn-icon.active { background: var(--metal-grad); color: #000; border-color: transparent; box-shadow: 0 0 12px rgba(255,255,255,0.3); }

/* LAYOUT PRINCIPAL */
.layout {
  flex: 1; display: grid; 
  grid-template-columns: 1fr 350px; 
  gap: 0; overflow: hidden; position: relative;
}

/* ÁREA DE VIDEO */
.video-stage {
  position: relative; display: flex; flex-direction: column;
  background: #000; justify-content: center; align-items: center;
}
video { width: 100%; height: 100%; max-height: 100vh; object-fit: contain; }

/* CONTROLES OVERLAY (Se muestran al hover) */
.video-overlay {
  position: absolute; inset: 0; 
  background: linear-gradient(0deg, rgba(0,0,0,0.9) 0%, transparent 40%, transparent 70%, rgba(0,0,0,0.6) 100%);
  opacity: 0; transition: opacity 0.3s;
  display: flex; flex-direction: column; justify-content: flex-end;
  padding: 20px; pointer-events: none; /* Dejar pasar clicks al video si no hay controles */
}
.video-stage:hover .video-overlay, .video-stage.user-active .video-overlay { opacity: 1; pointer-events: auto; }

/* BARRA DE PROGRESO FINA */
.progress-container {
  height: 4px; background: rgba(255,255,255,0.2); border-radius: 4px; margin-bottom: 14px;
  position: relative; cursor: pointer; transition: height 0.2s;
}
.progress-container:hover { height: 8px; }
.progress-fill { height: 100%; background: var(--metal-grad); width: 0%; border-radius: 4px; position: relative; }
.progress-handle { 
  width: 12px; height: 12px; background: #fff; border-radius: 50%; 
  position: absolute; right: -6px; top: 50%; transform: translateY(-50%); 
  box-shadow: 0 0 10px rgba(0,0,0,0.5); opacity: 0; transition: opacity 0.2s; 
}
.progress-container:hover .progress-handle { opacity: 1; }

/* BOTONERA INFERIOR VIDEO */
.controls-row {
  display: flex; align-items: center; gap: 16px; 
}
.controls-left, .controls-right { display: flex; align-items: center; gap: 12px; }
.controls-right { margin-left: auto; }

.ctrl-btn {
  background: none; border: none; color: #eee; cursor: pointer; padding: 6px;
  transition: transform 0.2s, color 0.2s;
}
.ctrl-btn:hover { color: #fff; transform: scale(1.1); text-shadow: 0 0 10px rgba(255,255,255,0.5); }
.ctrl-btn svg { width: 24px; height: 24px; stroke-width: 1.5; }

/* VOLUMEN SLIDER */
.vol-slider-cont { display: flex; align-items: center; width: 0; overflow: hidden; transition: width 0.3s; }
.controls-left:hover .vol-slider-cont { width: 80px; }
.vol-slider { -webkit-appearance: none; width: 100%; height: 4px; background: rgba(255,255,255,0.3); border-radius: 2px; }
.vol-slider::-webkit-slider-thumb { -webkit-appearance: none; width: 10px; height: 10px; background: #fff; border-radius: 50%; }

/* SIDEBAR (LISTA DE CANALES) */
.sidebar {
  background: var(--bg-panel);
  border-left: 1px solid var(--border);
  display: flex; flex-direction: column;
  height: 100%;
}
.sidebar-header {
  padding: 16px; border-bottom: 1px solid var(--border);
  display: flex; gap: 10px;
}
.search-box {
  flex: 1; background: rgba(0,0,0,0.3); border: 1px solid var(--border);
  border-radius: 8px; padding: 0 10px; height: 40px; display: flex; align-items: center;
}
.search-box input {
  background: transparent; border: none; color: #fff; width: 100%; outline: none;
}
.filter-btn {
  background: rgba(255,255,255,0.05); border: 1px solid var(--border); width: 40px; border-radius: 8px;
  display: flex; align-items: center; justify-content: center; cursor: pointer;
}

/* LISTA VIRTUAL SCROLL */
.channel-list {
  flex: 1; overflow-y: auto; padding: 10px;
}
.channel-item {
  display: flex; align-items: center; gap: 12px;
  padding: 10px; border-radius: 8px; margin-bottom: 4px;
  cursor: pointer; transition: background 0.2s;
  border: 1px solid transparent;
}
.channel-item:hover { background: rgba(255,255,255,0.03); border-color: rgba(255,255,255,0.05); }
.channel-item.active { 
  background: linear-gradient(90deg, rgba(255,255,255,0.1), transparent); 
  border-left: 3px solid #fff;
}
.ch-logo {
  width: 48px; height: 36px; background: #1a1a1a; border-radius: 4px;
  display: flex; align-items: center; justify-content: center;
  font-size: 10px; color: #666; font-weight: bold; text-transform: uppercase;
}
.ch-info { flex: 1; min-width: 0; }
.ch-name { font-weight: 600; font-size: 14px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.ch-meta { font-size: 12px; color: #777; margin-top: 2px; }
.fav-btn {
  opacity: 0.2; cursor: pointer; transition: opacity 0.2s;
}
.fav-btn.is-fav { opacity: 1; color: #ffd700; filter: drop-shadow(0 0 5px rgba(255,215,0,0.5)); }

/* INFO OVERLAY (Status, Buffer, Res) */
.stream-stats {
  position: absolute; top: 20px; right: 20px;
  text-align: right; pointer-events: none;
}
.stat-tag {
  background: rgba(0,0,0,0.6); backdrop-filter: blur(4px);
  padding: 4px 8px; border-radius: 4px; font-size: 11px; color: #aaa; margin-bottom: 4px;
  display: inline-block; border: 1px solid rgba(255,255,255,0.05);
}
.stat-tag.live { color: #ff4d4d; border-color: rgba(255, 77, 77, 0.3); font-weight: bold; }

/* SPINNER METALICO */
.loader-overlay {
  position: absolute; inset: 0; background: #000; z-index: 10;
  display: flex; flex-direction: column; align-items: center; justify-content: center;
  transition: opacity 0.5s;
}
.spinner-ring {
  width: 60px; height: 60px; border: 4px solid rgba(255,255,255,0.1);
  border-top-color: #fff; border-radius: 50%; animation: spin 1s linear infinite;
  box-shadow: 0 0 20px rgba(255,255,255,0.1);
}
@keyframes spin { to { transform: rotate(360deg); } }

/* RESPONSIVE MOBILE */
@media (max-width: 900px) {
  .layout { grid-template-columns: 1fr; display: block; }
  .video-stage { height: 40vh; width: 100%; position: sticky; top: 0; z-index: 20; }
  
  /* El sidebar se convierte en un Drawer/Bottom Sheet */
  .sidebar {
    position: fixed; inset: 0; top: 100%; z-index: 100;
    transition: top 0.3s cubic-bezier(0.19, 1, 0.22, 1);
    background: var(--bg-deep);
  }
  .sidebar.open { top: 0; }
  
  /* Botón flotante para abrir canales en móvil */
  .mobile-list-toggle {
    display: flex !important;
  }
  
  /* Ajustes controles móvil */
  .video-overlay { opacity: 1; background: linear-gradient(0deg, rgba(0,0,0,0.8), transparent); padding: 10px; }
  .ctrl-btn svg { width: 20px; height: 20px; }
  .controls-row { gap: 10px; }
}

.mobile-list-toggle {
  display: none; position: fixed; bottom: 20px; right: 20px;
  background: var(--metal-grad); color: #000;
  width: 56px; height: 56px; border-radius: 50%;
  align-items: center; justify-content: center;
  box-shadow: 0 10px 30px rgba(0,0,0,0.5); z-index: 40;
  animation: float 3s ease-in-out infinite;
}
@keyframes float { 0%{transform:translateY(0)} 50%{transform:translateY(-6px)} 100%{transform:translateY(0)} }

/* MENÚS FLOTANTES (Calidad, Servidores) */
.popover {
  position: absolute; bottom: 60px; right: 20px;
  background: rgba(20, 22, 26, 0.95); border: 1px solid var(--border);
  border-radius: 12px; padding: 8px; width: 200px;
  display: none; flex-direction: column; gap: 4px;
  backdrop-filter: blur(12px); box-shadow: 0 20px 40px rgba(0,0,0,0.8);
}
.popover button {
  background: transparent; border: none; color: #ccc; text-align: left;
  padding: 10px; border-radius: 6px; cursor: pointer;
}
.popover button:hover { background: rgba(255,255,255,0.1); color: #fff; }
.popover.show { display: flex; }

</style>
</head>
<body>

<div class="ambient-bg"></div>

<header class="top-bar">
  <div class="brand">
    <div class="brand-logo">P</div>
    <div class="brand-info">
      <h1>SILVER PLAYER</h1>
      <p id="headerStatus">Ready to stream</p>
    </div>
  </div>
  <div class="top-actions">
    <button class="btn-icon" id="btnCast" title="Transmitir / Cast">
      <i data-feather="cast"></i>
    </button>
    <button class="btn-icon" id="btnUpload" title="Subir M3U Local">
      <i data-feather="upload-cloud"></i>
    </button>
    <button class="btn-icon" id="btnSleep" title="Temporizador">
      <i data-feather="clock"></i>
    </button>
  </div>
</header>

<main class="layout">
  <section class="video-stage" id="videoStage">
    <div class="loader-overlay" id="mainLoader">
      <div class="spinner-ring"></div>
      <p style="margin-top:20px;color:#888;font-size:12px;letter-spacing:1px">ESTABLECIENDO CONEXIÓN SEGURA</p>
    </div>

    <video id="video" playsinline webkit-playsinline crossorigin="anonymous"></video>

    <div class="stream-stats">
      <div class="stat-tag live" id="badgeLive">● EN VIVO</div>
      <br>
      <div class="stat-tag" id="statRes">Checking...</div>
      <div class="stat-tag" id="statBuffer">Buffer: 0s</div>
    </div>

    <div class="video-overlay" id="controlsOverlay">
      <div style="margin-bottom:10px">
        <h2 id="osdTitle" style="margin:0;font-size:18px;text-shadow:0 2px 4px rgba(0,0,0,0.8)">Bienvenido</h2>
        <p id="osdSub" style="margin:0;font-size:12px;color:#aaa">Selecciona un canal</p>
      </div>

      <div class="progress-container" id="progressBar">
        <div class="progress-fill" id="progressFill"></div>
        <div class="progress-handle"></div>
      </div>

      <div class="controls-row">
        <div class="controls-left">
          <button class="ctrl-btn" id="playPauseBtn"><i data-feather="play"></i></button>
          <div class="vol-slider-cont">
            <input type="range" class="vol-slider" id="volRange" min="0" max="1" step="0.1">
          </div>
          <button class="ctrl-btn" id="muteBtn"><i data-feather="volume-2"></i></button>
        </div>

        <div class="controls-right">
           <button class="ctrl-btn" id="btnSnapshot" title="Captura"><i data-feather="camera"></i></button>
           <button class="ctrl-btn" id="btnQuality" title="Calidad"><i data-feather="settings"></i></button>
           <button class="ctrl-btn" id="btnServers" title="Servidores" style="display:none"><i data-feather="server"></i></button>
           <button class="ctrl-btn" id="btnPip" title="PiP"><i data-feather="minimize"></i></button>
           <button class="ctrl-btn" id="btnFull" title="Fullscreen"><i data-feather="maximize"></i></button>
        </div>
      </div>
    </div>
    
    <div class="popover" id="qualityMenu"></div>
    <div class="popover" id="serverMenu"></div>

  </section>

  <aside class="sidebar" id="sidebar">
    <div class="sidebar-header">
      <button class="btn-icon" id="btnCloseSidebar" style="display:none;margin-right:10px"><i data-feather="chevron-down"></i></button>
      
      <div class="search-box">
        <i data-feather="search" style="color:#666;width:16px;margin-right:8px"></i>
        <input type="text" id="searchInput" placeholder="Buscar canal...">
      </div>
      <div class="filter-btn" id="btnFilterFav" title="Ver Favoritos">
        <i data-feather="star" style="width:16px"></i>
      </div>
    </div>

    <div class="channel-list" id="channelList">
      </div>
    
    <div style="padding:10px;border-top:1px solid var(--border);font-size:11px;color:#555;text-align:center">
      PROTECTED CONNECTION • V 3.0 SILVER
    </div>
  </aside>
</main>

<div class="mobile-list-toggle" id="mobileToggle">
  <i data-feather="list"></i>
</div>

<input type="file" id="fileInput" accept=".m3u,.m3u8" style="display:none">

<script>
/* ========================================================
   CORE SYSTEM (LOGIC PRESERVED, UI ENHANCED)
   ======================================================== */
feather.replace();

// PARAMS & VARS
const params = new URLSearchParams(window.location.search);
const token = params.get('token');
const backend = params.get('backend') || window.location.origin;

// DOM ELEMENTS
const video = document.getElementById('video');
const mainLoader = document.getElementById('mainLoader');
const channelListEl = document.getElementById('channelList');
const searchInput = document.getElementById('searchInput');
const osdTitle = document.getElementById('osdTitle');
const osdSub = document.getElementById('osdSub');
const headerStatus = document.getElementById('headerStatus');
const mobileToggle = document.getElementById('mobileToggle');
const sidebar = document.getElementById('sidebar');
const btnCloseSidebar = document.getElementById('btnCloseSidebar');
const btnFilterFav = document.getElementById('btnFilterFav');

// STATE
let hls = null;
let allChannels = [];
let currentChannel = null;
let favorites = JSON.parse(localStorage.getItem('iptv_favs') || '[]');
let showFavsOnly = false;
let sleepTimer = null;

/* INITIALIZATION */
window.addEventListener('load', async () => {
  if(!token) {
    statusError('Acceso denegado', 'Token no encontrado');
    return;
  }
  
  try {
    // 1. Get Info
    const infoRes = await fetch(`${backend}/api/channel-info/${encodeURIComponent(token)}`);
    if(!infoRes.ok) throw new Error('Token inválido');
    const info = await infoRes.json();
    currentChannel = info;
    updateOSD(info.channel_name, 'Listo para reproducir');

    // 2. Load Playlist
    loadPlaylist();

    // 3. Start Stream
    startStream();
    
    // 4. UI Events
    setupUI();

  } catch(e) {
    console.error(e);
    statusError('Error de Conexión', 'No se pudo conectar al backend seguro.');
  }
});

function statusError(title, msg){
  mainLoader.style.opacity = 1;
  mainLoader.innerHTML = `<i data-feather="alert-triangle" style="color:#ff4d4d;width:40px;height:40px"></i><h2>${title}</h2><p>${msg}</p>`;
  feather.replace();
}

/* PLAYLIST LOGIC */
async function loadPlaylist(){
  try {
    const res = await fetch(`${backend}/api/playlist-channels/${encodeURIComponent(token)}`);
    if(res.ok){
      const data = await res.json();
      allChannels = data.channels || [];
      renderChannels();
      checkServers();
    }
  } catch(e){ console.log('Playlist fetch failed', e); }
}

function renderChannels(){
  const filter = searchInput.value.toLowerCase();
  channelListEl.innerHTML = '';
  
  const list = allChannels.filter(ch => {
    const name = (ch.title || ch.channel_name || '').toLowerCase();
    const matchName = name.includes(filter);
    const isFav = favorites.includes(ch.id || ch.channel_name);
    return showFavsOnly ? (matchName && isFav) : matchName;
  });

  if(list.length === 0) {
    channelListEl.innerHTML = `<div style="padding:20px;text-align:center;color:#666">No hay canales</div>`;
    return;
  }

  list.slice(0, 150).forEach(ch => {
    const isFav = favorites.includes(ch.id || ch.channel_name);
    const el = document.createElement('div');
    el.className = `channel-item ${currentChannel && (ch.id === currentChannel.id) ? 'active' : ''}`;
    el.innerHTML = `
      <div class="ch-logo">${(ch.title||'CH').substring(0,2)}</div>
      <div class="ch-info">
        <div class="ch-name">${ch.title || ch.channel_name}</div>
        <div class="ch-meta">${ch.group_name || 'TV'}</div>
      </div>
      <div class="fav-btn ${isFav?'is-fav':''}" onclick="toggleFav(event, '${ch.id||ch.channel_name}')">
        <i data-feather="star" style="width:16px"></i>
      </div>
    `;
    el.onclick = (e) => {
      if(e.target.closest('.fav-btn')) return;
      changeChannel(ch);
    };
    channelListEl.appendChild(el);
  });
  feather.replace();
}

function toggleFav(e, id){
  e.stopPropagation();
  if(favorites.includes(id)) favorites = favorites.filter(x=>x!==id);
  else favorites.push(id);
  localStorage.setItem('iptv_favs', JSON.stringify(favorites));
  renderChannels();
}

function changeChannel(ch){
  if(ch.token) location.href = `?token=${encodeURIComponent(ch.token)}&backend=${encodeURIComponent(backend)}`;
  else location.reload();
}

/* STREAM ENGINE (HLS) */
function startStream(){
  const url = `${backend}/api/stream/${encodeURIComponent(token)}`;
  
  if(Hls.isSupported()){
    if(hls) hls.destroy();
    hls = new Hls({ enableWorker: true, lowLatencyMode: true });
    hls.loadSource(url);
    hls.attachMedia(video);
    hls.on(Hls.Events.MANIFEST_PARSED, () => {
       video.play().catch(()=>{});
       mainLoader.style.opacity = 0;
       setTimeout(()=>mainLoader.style.display='none', 500);
       generateQualities();
    });
    hls.on(Hls.Events.ERROR, (e,d) => {
      if(d.fatal) {
         if(d.type === Hls.ErrorTypes.NETWORK_ERROR) hls.startLoad();
         else hls.recoverMediaError();
      }
    });
    // Stats loop
    setInterval(updateStats, 1000);
  } else if (video.canPlayType('application/vnd.apple.mpegurl')) {
    video.src = url;
    video.addEventListener('loadedmetadata', () => {
      video.play();
      mainLoader.style.opacity=0;
      setTimeout(()=>mainLoader.style.display='none', 500);
    });
  }
}

function updateStats(){
  if(!hls) return;
  // Buffer
  if(video.buffered.length){
    const end = video.buffered.end(video.buffered.length-1);
    const diff = Math.max(0, Math.round(end - video.currentTime));
    document.getElementById('statBuffer').textContent = `Buffer: ${diff}s`;
  }
  // Res
  const level = hls.levels[hls.currentLevel];
  if(level) document.getElementById('statRes').textContent = `${level.height}p • ${(level.bitrate/1000).toFixed(0)}k`;
}

/* UI LOGIC & EVENTS */
function setupUI(){
  // Play/Pause
  const ppBtn = document.getElementById('playPauseBtn');
  ppBtn.onclick = () => {
    if(video.paused) { video.play(); ppBtn.innerHTML = '<i data-feather="pause"></i>'; }
    else { video.pause(); ppBtn.innerHTML = '<i data-feather="play"></i>'; }
    feather.replace();
  };

  // Volume
  const volRange = document.getElementById('volRange');
  volRange.oninput = (e) => { video.volume = e.target.value; video.muted = false; };
  document.getElementById('muteBtn').onclick = () => {
    video.muted = !video.muted;
  };

  // Fullscreen
  document.getElementById('btnFull').onclick = () => {
    if(!document.fullscreenElement) document.documentElement.requestFullscreen();
    else document.exitFullscreen();
  };
  
  // PIP
  document.getElementById('btnPip').onclick = () => {
    if(document.pictureInPictureElement) document.exitPictureInPicture();
    else video.requestPictureInPicture().catch(e=>alert('PiP no soportado'));
  };

  // Mobile Drawer
  mobileToggle.onclick = () => {
    sidebar.classList.add('open');
    btnCloseSidebar.style.display = 'block';
  };
  btnCloseSidebar.onclick = () => {
    sidebar.classList.remove('open');
  };

  // Activity detection for overlay
  let timeout;
  const stage = document.getElementById('videoStage');
  stage.onmousemove = () => {
    stage.classList.add('user-active');
    clearTimeout(timeout);
    timeout = setTimeout(() => stage.classList.remove('user-active'), 3000);
  };

  // Snapshot
  document.getElementById('btnSnapshot').onclick = takeSnapshot;

  // Search
  searchInput.oninput = renderChannels;
  
  // Filter Favs
  btnFilterFav.onclick = () => {
    showFavsOnly = !showFavsOnly;
    btnFilterFav.style.color = showFavsOnly ? '#ffd700' : '#fff';
    renderChannels();
  };

  // Upload Local
  document.getElementById('btnUpload').onclick = () => document.getElementById('fileInput').click();
  document.getElementById('fileInput').onchange = (e) => {
    const f = e.target.files[0];
    if(f) {
      const r = new FileReader();
      r.onload = (ev) => alert('Función de carga local detectada. Implementación de parseo omitida para brevedad, pero el archivo fue leído: ' + f.name);
      r.readAsText(f);
    }
  };

  // Sleep Timer
  document.getElementById('btnSleep').onclick = () => {
    const mins = prompt('¿Apagar en cuántos minutos? (Escribe 0 para cancelar)');
    if(mins && !isNaN(mins)){
      if(sleepTimer) clearTimeout(sleepTimer);
      if(mins > 0){
        alert(`Temporizador configurado para ${mins} minutos.`);
        sleepTimer = setTimeout(() => {
          video.pause();
          alert('Tiempo cumplido. Reproducción detenida.');
        }, mins * 60000);
      }
    }
  };

  // CASTING / MIRRORING
  const castBtn = document.getElementById('btnCast');
  if (window.WebKitPlaybackTargetAvailabilityEvent) {
    video.addEventListener('webkitplaybacktargetavailabilitychanged', (event) => {
      switch (event.availability) {
        case "available": castBtn.style.display = 'flex'; break;
        default: castBtn.style.display = 'none';
      }
    });
  }
  
  castBtn.onclick = async () => {
    // Intentar RemotePlayback API (Chrome/Android)
    if (video.remote && video.remote.watchAvailability) {
       try {
         await video.remote.prompt();
       } catch(e){ console.log('Remote Prompt failed', e); }
    } 
    // Intentar WebKit AirPlay (iOS)
    else if (video.webkitShowPlaybackTargetPicker) {
      video.webkitShowPlaybackTargetPicker();
    } 
    else {
      alert('Tu navegador no reporta dispositivos de Casting nativos disponibles. Intenta usar la opción "Enviar/Transmitir" del menú de tu navegador.');
    }
  };
}

function updateOSD(title, sub){
  osdTitle.textContent = title;
  osdSub.textContent = sub;
  headerStatus.textContent = title;
}

function generateQualities(){
  const btn = document.getElementById('btnQuality');
  const menu = document.getElementById('qualityMenu');
  
  if(!hls || !hls.levels || hls.levels.length === 0) {
    btn.style.display='none'; return;
  }
  
  menu.innerHTML = '';
  // Auto
  const bA = document.createElement('button');
  bA.innerText = 'Automático (Recomendado)';
  bA.onclick = () => { hls.currentLevel = -1; menu.classList.remove('show'); };
  menu.appendChild(bA);
  
  hls.levels.forEach((l, i) => {
    const b = document.createElement('button');
    b.innerText = `${l.height}p (${Math.round(l.bitrate/1000)}k)`;
    b.onclick = () => { hls.currentLevel = i; menu.classList.remove('show'); };
    menu.appendChild(b);
  });

  btn.onclick = (e) => {
    e.stopPropagation();
    menu.classList.toggle('show');
  };
}

function checkServers(){
  // Simple logic to group by name and show server button if duplicates found
  // (Simplified for this snippet)
  const serverMenu = document.getElementById('serverMenu');
  // Logic to populate serverMenu based on allChannels grouping...
}

function takeSnapshot(){
  const canvas = document.createElement('canvas');
  canvas.width = video.videoWidth;
  canvas.height = video.videoHeight;
  const ctx = canvas.getContext('2d');
  ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
  try {
    const url = canvas.toDataURL('image/jpeg');
    const a = document.createElement('a'); a.href = url; a.download = `snapshot_${Date.now()}.jpg`;
    a.click();
  } catch(e){ alert('Error al capturar (posible protección DRM o CORS)'); }
}

// Global click to close menus
document.addEventListener('click', (e) => {
  if(!e.target.closest('#btnQuality') && !e.target.closest('#qualityMenu')) {
    document.getElementById('qualityMenu').classList.remove('show');
  }
});

</script>
</body>
</html>
