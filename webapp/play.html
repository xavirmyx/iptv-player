<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
  <title>IptvChekProk_bot — Reproductor (Debug mejorado)</title>
  <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
  <style>
    /* (estilos compactados: usa los tuyos si prefieres) */
    body{margin:12px;background:#05060a;color:#fff;font-family:-apple-system,Segoe UI,Arial}
    .card{background:rgba(255,255,255,0.02);border-radius:12px;padding:12px}
    .overlay{background:rgba(0,0,0,0.7);padding:16px;border-radius:8px}
    button{padding:8px 12px;border-radius:8px;border:0;background:#222;color:#fff;cursor:pointer}
  </style>
</head>
<body>
  <div class="card">
    <h3>IptvChekProk_bot — Reproductor</h3>
    <div id="ui">
      <div id="statusBox" class="overlay">
        <strong id="ovTitle">Iniciando</strong>
        <div id="ovMsg">Preparando...</div>
        <div style="margin-top:8px">
          <button id="retryBtn" style="display:none">Reintentar</button>
        </div>
      </div>

      <div style="margin-top:12px">
        <video id="video" controls playsinline style="width:100%;max-height:60vh;background:#000"></video>
      </div>

      <div style="margin-top:8px">
        <div id="debug" style="font-size:13px;color:#cbd5e1"></div>
      </div>
    </div>
  </div>

  <script>
  (function(){
    const video = document.getElementById('video');
    const ovTitle = document.getElementById('ovTitle');
    const ovMsg = document.getElementById('ovMsg');
    const retryBtn = document.getElementById('retryBtn');
    const debug = document.getElementById('debug');

    // token y api desde querystring
    const params = new URLSearchParams(location.search);
    const token = params.get('token');
    // si quieres usar un endpoint diferente: ?api=https://miapi.com/api/stream-info
    const apiParam = params.get('api');

    // endpoints por defecto (intenta en orden)
    const endpoints = [];
    if (apiParam) endpoints.push(apiParam);
    // endpoint absoluto sugerido (tu versión previa)
    endpoints.push('https://iptvpro-check-5nvh.onrender.com/api/stream-info');
    // endpoint relativo (por si sirve con proxy en mismo dominio)
    endpoints.push('/api/stream-info');

    let _hls = null;
    let _streamUrl = null;
    let _tried = [];

    function setStatus(title, msg, showRetry=false){
      ovTitle.textContent = title;
      ovMsg.textContent = msg;
      retryBtn.style.display = showRetry ? 'inline-block' : 'none';
      debug.innerText = `Intentados: ${_tried.join(' | ')}`;
    }

    async function tryFetchInfo(){
      if (!token) {
        setStatus('❌ Token faltante', 'Añade ?token=TU_TOKEN a la URL.', false);
        return;
      }
      setStatus('Conectando', 'Probando endpoints disponibles...');
      for (const base of endpoints){
        if (!base) continue;
        const url = base + (base.includes('?') ? '&' : '?') + 'token=' + encodeURIComponent(token);
        _tried.push(base);
        // intentamos llamar
        try {
          setStatus('Conectando', `Probando: ${base}`);
          const controller = new AbortController();
          const timeout = setTimeout(()=> controller.abort(), 10000);
          const res = await fetch(url, { method: 'GET', credentials: 'include', signal: controller.signal });
          clearTimeout(timeout);
          if (!res.ok){
            // leer body (puede ayudar a diagnosticar)
            let txt = '';
            try { txt = await res.text(); } catch(e) { txt = '(no body)'; }
            setStatus('❌ Respuesta del servidor', `HTTP ${res.status} - ${res.statusText}. ${txt}`, true);
            // si falla, seguimos probando otros endpoints
            continue;
          }
          const data = await res.json();
          // basic validation
          if (!data || !data.stream_url){
            setStatus('❌ Respuesta inválida', 'El servidor no devolvió stream_url válido.', true);
            continue;
          }
          // ok: tenemos info (guardamos url de forma privada)
          setStatus('Conectado', 'Reproduciendo...', false);
          _streamUrl = data.stream_url; // NO se muestra
          // iniciar playback
          await startPlayback(_streamUrl, data);
          // limpiar variable local que contenía la URL (intento de reducir exposición)
          // OJO: hls.js necesita la URL internamente; aquí borramos la referencia externa
          _streamUrl = null;
          return;
        } catch (err) {
          // si es abort (timeout) o otro error de fetch: mostramos y probamos siguiente
          const msg = (err.name === 'AbortError') ? 'Timeout (10s) al conectar' : (err.message || String(err));
          setStatus('❌ Error de conexión', `${base} → ${msg}`, true);
          continue;
        }
      }
      // si llegamos aquí, ninguno funcionó
      setStatus('❌ Ningún endpoint respondió', 'Revisa CORS, token y que la API esté en línea. Usa el botón Reintentar.', true);
    }

    async function startPlayback(streamUrl, meta){
      try {
        // si es HLS...
        if (streamUrl.includes('.m3u8') && window.Hls && Hls.isSupported()){
          if (_hls) try{ _hls.destroy(); }catch(e){}
          _hls = new Hls({ enableWorker:true, maxBufferLength:30 });
          _hls.loadSource(streamUrl);
          _hls.attachMedia(video);
          _hls.on(Hls.Events.MANIFEST_PARSED, function(){
            video.play().catch(()=>{});
          });
          _hls.on(Hls.Events.ERROR, function(_, data){
            console.error && console.error('HLS error:', data); // esto no contiene la url normalmente
          });
        } else {
          video.src = streamUrl;
          video.addEventListener('loadeddata', ()=> video.play().catch(()=>{}), { once:true });
          video.addEventListener('error', ()=> setStatus('❌ Error reproducción', 'El elemento video no pudo reproducir el recurso.', true), { once:true });
        }
      } catch (e) {
        setStatus('❌ Error interno', e.message || String(e), true);
      }
    }

    retryBtn.addEventListener('click', ()=>{
      _tried = [];
      tryFetchInfo();
    });

    // inicio automático
    window.addEventListener('load', ()=> {
      tryFetchInfo();
    });

    // limpiar referencias si cierra
    window.addEventListener('beforeunload', ()=> {
      try{ if (_hls) _hls.destroy(); }catch(e){}
    });
  })();
  </script>
</body>
</html>
